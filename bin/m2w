#!/usr/bin/env ruby

require 'uri'
require 'json'
require 'mail'
require 'tempfile'
require 'awesome_print'

DEBUG = false
DATE_FORMAT = "%Y-%W"
KEY_FORMAT = "%F %T"

content = ARGF.read
tmpfile = Tempfile.new('mail-')
tmpfile.write content
tmpfile.close

mail = Mail.read tmpfile.path

ap mail.methods if DEBUG

datestamp = mail.date.strftime DATE_FORMAT
keystamp = mail.date.strftime KEY_FORMAT
storefile = "web/json/#{datestamp}.json"
dirfile = 'web/json/dirs.json'

if File.exists?(dirfile)
  dirs = JSON.parse(File.read dirfile)
else
  dirs = []
end

unless dirs.include?(datestamp)
  dirs.push datestamp
  dirs.sort
  File.open(dirfile, 'w') do |f|
    f.write(dirs.to_json)
  end
end

if File.exists?(storefile)
  data = JSON.parse(File.read storefile)
else
  data = {}
end

def urlize(txt)
  note.split.each do |word|
    if word =~ URI::regexp
      '<a href="' + word + '">' + word + '</a>'
    else
      word
    end
  end.join ' '
end

def to_html(text)
  back = '<pre>'
  text.each_line do |line|
    back += urlize(line) + "\n"
  end
  back += '</pre>'
  return back
end

if mail.multipart?
  content = mail.html_part.body.to_s
else
  content = to_html(mail.body.to_s)
end

data[keystamp] = {
  id: mail.message_id,
  date: keystamp,
  from: mail.from.first,
  subject: mail.subject
}
data.ksort!

File.open(storefile, 'w') do |f|
  f.write(data.to_json)
end

File.open("web/mails/#{mail.message_id}.html", 'w') do |f|
  f.write(content)
end
