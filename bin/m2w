#!/usr/bin/env ruby

require 'json'
require 'mail'
require 'tempfile'
require 'awesome_print'

DEBUG = true
DATE_FORMAT = "%Y-%W"
KEY_FORMAT = "%FT%R"

content = ARGF.read
tmpfile = Tempfile.new('mail-')
tmpfile.write content
tmpfile.close

mail = Mail.read tmpfile.path

ap mail.methods if DEBUG

datestamp = mail.date.strftime DATE_FORMAT
keystamp = mail.date.strftime KEY_FORMAT
storefile = "web/json/#{datestamp}.json"
dirfile = 'web/json/dirs.json'

if File.exists?(dirfile)
  dirs = JSON.parse(File.read dirfile)
else
  dire = []
end

unless dirs.include?(datestamp)
  dirs.push datestamp
  dirs.sort
  File.open('web/json/dirs.json', 'w') do |f|
    f.write(dirs.to_json)
  end
end

if File.exists?(storefile)
  data = JSON.parse(File.read storefile)
else
  data = {}
end

def to_html(text)
  text
end

if mail.multipart?
  content = mail.html_part.body.to_s
else
  content = to_html(mail.body.to_s)
end

